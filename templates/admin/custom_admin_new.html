{% extends "admin/base_site.html" %}
{% block content %}
  <!-- Main Container -->
  <div style="display: flex; height: 90vh; background-color: #f8fafc; font-family: system-ui, -apple-system, sans-serif;">
    <!-- Left Sidebar - User List -->
    <div id="user-list" style="width: 320px; background-color: white; border-right: 1px solid #e2e8f0;">
      <!-- Header -->
      <div style="padding: 20px; border-bottom: 1px solid #e2e8f0; background-color: white;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
          <h1 style="font-size: 20px; font-weight: 600; color: #1e293b;">Customer Chats</h1>
          <div style="display: flex; gap: 8px;">
            <button style="padding: 8px; border-radius: 8px; border: none; background-color: #f1f5f9; cursor: pointer;">
              <svg style="width: 20px; height: 20px; color: #64748b;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
              </svg>
            </button>
          </div>
        </div>
        <div style="position: relative;">
          <input type="text" placeholder="Search customers..."
                 style="width: 100%; padding: 10px 16px; padding-left: 36px; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f8fafc; color: #1e293b;">
          <svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: #94a3b8;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>

      <!-- User List -->
      <div style="overflow-y: auto; height: calc(90vh - 100px);">
        {% for user in users %}
          <div class="user-item" data-user-id="{{ user.id }}" data-user-name="{{ user.full_name|default:user.phone_number }}"
               style="padding: 16px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <!-- User Avatar -->
              <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500; font-size: 16px;">
                {{ user.full_name|default:user.phone_number|slice:":1"|upper }}
              </div>
              <!-- User Info -->
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px;">
                  <span style="font-weight: 500; color: #1e293b; font-size: 14px;">
                    {{ user.full_name|default:user.phone_number }}
                  </span>
                  <span style="font-size: 12px; color: #64748b;">12:45</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 13px; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    +{{ user.phone_number }}
                  </span>
                  <div style="width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%;"></div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Main Chat Area -->
    <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
      <!-- Empty State -->
      <div id="empty-state" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #64748b; padding: 20px;">
        <svg style="width: 64px; height: 64px; color: #94a3b8; margin-bottom: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <h3 style="font-size: 16px; font-weight: 500; color: #1e293b; margin-bottom: 8px;">Select a customer to start chatting</h3>
        <p style="font-size: 14px; color: #64748b; text-align: center; max-width: 400px;">
          Choose a customer from the left sidebar to view their chat history and details
        </p>
      </div>

      <!-- Chat Interface (Hidden by default) -->
      <div id="chat-interface" style="display: none; flex: 1; flex-direction: column;">
        <!-- Chat Header -->
        <div id="chat-user-header" style="padding: 16px 24px; background-color: white; border-bottom: 1px solid #e2e8f0;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500; font-size: 16px;"></div>
              <div>
                <div style="font-weight: 500; color: #1e293b; font-size: 15px;">Select a user</div>
                <div style="font-size: 13px; color: #64748b;">No user selected</div>
              </div>
            </div>
            <!-- Customer Info Button -->
            <button id="show-customer-info" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 8px; background-color: white; color: #1e293b; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: all 0.2s;">
              <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Customer Info
            </button>
          </div>
        </div>

        <!-- Chat Messages -->
        <div id="chat-box" style="flex: 1; overflow-y: auto; padding: 24px; background-color: #f8fafc;"></div>

        <!-- Input Area -->
        <div class="message-input" style="padding: 16px 24px; background-color: white; border-top: 1px solid #e2e8f0;">
          <div style="display: flex; gap: 12px; align-items: center;">
            <label style="cursor: pointer;">
              <input type="file" id="image-upload" accept="image/*" style="display: none;">
              <div style="padding: 8px; border-radius: 8px; background-color: #f8fafc; transition: all 0.2s;">
                <svg style="width: 22px; height: 22px; color: #64748b;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
            </label>

            <textarea id="message-box" placeholder="Type your message..."
                      style="flex: 1; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f8fafc; font-size: 14px; resize: none; min-height: 44px; max-height: 120px;"></textarea>

            <button id="send-button" style="padding: 10px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
              Send
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Info Sidebar (Hidden by default) -->
    <div id="customer-info-sidebar" style="width: 380px; background-color: white; border-left: 1px solid #e2e8f0; display: none;">
      <div style="padding: 20px; border-bottom: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="font-size: 18px; font-weight: 600; color: #1e293b;">Customer Details</h2>
          <button id="close-customer-info" style="padding: 8px; border: none; background: none; cursor: pointer;">
            <svg style="width: 20px; height: 20px; color: #64748b;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Customer Info Tabs -->
        <div style="display: flex; gap: 2px; background-color: #f1f5f9; padding: 4px; border-radius: 8px;">
          <button class="info-tab active" data-tab="info" style="flex: 1; padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; background-color: white; color: #1e293b;">
            Info
          </button>
          <button class="info-tab" data-tab="orders" style="flex: 1; padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; background-color: transparent; color: #64748b;">
            Orders
          </button>
        </div>
      </div>

      <!-- Tab Content -->
      <div id="info-content" class="tab-content" style="padding: 20px;">
        <div style="background-color: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <h3 style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 12px;">Contact Information</h3>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <div>
              <div style="font-size: 12px; color: #64748b; margin-bottom: 2px;">Full Name</div>
              <div style="font-size: 14px; color: #1e293b;" id="customer-name">-</div>
            </div>
            <div>
              <div style="font-size: 12px; color: #64748b; margin-bottom: 2px;">Phone Number</div>
              <div style="font-size: 14px; color: #1e293b;" id="customer-phone">-</div>
            </div>
            <div>
              <div style="font-size: 12px; color: #64748b; margin-bottom: 2px;">Email</div>
              <div style="font-size: 14px; color: #1e293b;" id="customer-email">-</div>
            </div>
          </div>
        </div>
      </div>

      <div id="orders-content" class="tab-content" style="display: none; padding: 20px;">
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <!-- Sample Order -->
          <div style="background-color: #f8fafc; border-radius: 8px; padding: 16px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="font-size: 14px; font-weight: 500; color: #1e293b;">Order #12345</span>
              <span style="font-size: 12px; color: #64748b;">Today, 14:30</span>
            </div>
            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">3 items • $156.00</div>
            <div style="display: inline-block; padding: 4px 8px; background-color: #dcfce7; color: #166534; font-size: 12px;border-radius: 6px;">Completed</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" style="display: none; position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.75); z-index: 50;">
      <button id="close-modal" style="position: fixed; top: 24px; right: 24px; background: white; width: 40px; height: 40px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
        <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <img id="modal-image" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;" />
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>

  <script>
    // Firebase Configuration
    var firebaseConfig = {
      apiKey: "AIzaSyAyI4LtoT9nzSJdm7a5_KOg2xDY16V5_7Y",
      authDomain: "aktilek-d3e26.firebaseapp.com",
      projectId: "aktilek-d3e26",
      storageBucket: "aktilek-d3e26.appspot.com",
      messagingSenderId: "818397511934",
      appId: "1:818397511934:web:a30ea103fa5ed8e97a25af"
    };

    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();
    var storage = firebase.storage();

    var selectedUserId = null;
    var adminId = {{ admin_id }};
    var selectedChatId = null;

    // Initialize UI state
    document.getElementById('chat-interface').style.display = 'none';
    document.getElementById('empty-state').style.display = 'flex';
    document.getElementById('customer-info-sidebar').style.display = 'none';

    // Customer Info Panel Toggle
    document.getElementById('show-customer-info').addEventListener('click', function() {
      const sidebar = document.getElementById('customer-info-sidebar');
      sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('close-customer-info').addEventListener('click', function() {
      document.getElementById('customer-info-sidebar').style.display = 'none';
    });

    // Tab Switching Logic
    document.querySelectorAll('.info-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        // Update tab styles
        document.querySelectorAll('.info-tab').forEach(t => {
          t.style.backgroundColor = 'transparent';
          t.style.color = '#64748b';
        });
        this.style.backgroundColor = 'white';
        this.style.color = '#1e293b';

        // Show correct content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = 'none';
        });
        document.getElementById(`${this.dataset.tab}-content`).style.display = 'block';
      });
    });

    // Subscribe to all chats
    subscribeToAllChats();

    function subscribeToAllChats() {
      console.log("Subscribing to all chats");
      let userIds = [{% for user in users %} {{ user.id }}, {% endfor %}];
      userIds.forEach(function(userId) {
        fetchChatId(userId).then(function(chatId) {
          if (chatId) {
            subscribeToChat(chatId, userId);
          }
        });
      });
    }

    // User selection handler
    document.querySelectorAll('.user-item').forEach(function(item) {
      item.addEventListener('click', function() {
        // Update UI state
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('chat-interface').style.display = 'flex';

        // Update user selection
        document.querySelectorAll('.user-item').forEach(function(user) {
          user.style.backgroundColor = 'white';
        });
        this.style.backgroundColor = '#f8fafc';

        selectedUserId = Number(this.getAttribute('data-user-id'));
        var userNameOrPhone = this.getAttribute('data-user-name');

        // Update chat header
        document.getElementById('chat-user-header').innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500; font-size: 16px;">
                ${userNameOrPhone.charAt(0).toUpperCase()}
              </div>
              <div>
                <div style="font-weight: 500; color: #1e293b; font-size: 15px;">${userNameOrPhone}</div>
                <div style="font-size: 13px; color: #64748b;">Online</div>
              </div>
            </div>
            <button id="show-customer-info" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 8px; background-color: white; color: #1e293b; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: all 0.2s;">
              <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Customer Info
            </button>
          </div>
        `;

        // Update customer info panel
        document.getElementById('customer-name').textContent = userNameOrPhone;
        document.getElementById('customer-phone').textContent = '+' + this.getAttribute('data-user-id');

        loadMessages(selectedUserId);
      });
    });

    // Message display function
    function displayMessage(messageData) {
      var chatBox = document.getElementById('chat-box');
      var messageCover = document.createElement('div');
      messageCover.style.display = "flex";
      messageCover.style.width = "100%";
      messageCover.style.marginBottom = "12px";

      var messageElement = document.createElement('div');
      messageElement.style.maxWidth = '70%';
      messageElement.style.padding = '12px 16px';
      messageElement.style.borderRadius = '12px';
      messageElement.style.fontSize = '14px';
      messageElement.style.lineHeight = '1.5';
      messageElement.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';

      if (messageData.sender_id == adminId) {
        messageCover.style.justifyContent = 'flex-end';
        messageElement.style.backgroundColor = '#3b82f6';
        messageElement.style.color = 'white';
      } else {
        messageCover.style.justifyContent = 'flex-start';
        messageElement.style.backgroundColor = 'white';
        messageElement.style.color = '#1e293b';
      }

      var messageContent = `
        <div>${messageData.content || ''}</div>
        ${messageData.image_url ? `
          <img src="${messageData.image_url}" alt="Image" class="chat-image"
               style="max-width: 300px; border-radius: 8px; margin-top: 8px; cursor: pointer;">
        ` : ''}
        <div style="font-size: 12px; margin-top: 4px; color: ${messageData.sender_id == adminId ? 'rgba(255,255,255,0.8)' : '#64748b'};">
          ${new Date(messageData.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
        </div>
      `;

      messageElement.innerHTML = messageContent;
      messageCover.appendChild(messageElement);
      chatBox.appendChild(messageCover);

      var chatImage = messageElement.querySelector('.chat-image');
      if (chatImage) {
        chatImage.addEventListener('click', function() {
          openImageModal(messageData.image_url);
        });
      }

      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Keep all your existing Firebase related functions
    function fetchChatId(userId) {
      return fetch(`/api/v2/chat/get-chat-id/?user_id=${userId}&admin_id=${adminId}`)
        .then(response => response.json())
        .then(data => {
          console.log("Received chat_id:", data.chat_id);
          return data.chat_id || null;
        });
    }

  </script>

  <style>
    /* Modern styling */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #e2e8f0;
      border-radius: 3px;
    }

    /* Hover effects */
    .user-item:hover {
      background-color: #f8fafc !important;
    }

    #send-button:hover {
      background-color: #2563eb;
    }

    /* Input focus styles */
    textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    /* Smooth transitions */
    .user-item,
    button,
    textarea {
      transition: all 0.2s ease-out;
    }

    /* Info tab hover effects */
    .info-tab:hover:not(.active) {
      background-color: #e2e8f0;
    }
  </style>

{% endblock %}